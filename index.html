<!DOCTYPE html>
<html class="light" lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>FileVault | User Library</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
</head>
<body class="bg-[#f6f6f8] min-h-screen font-sans text-slate-800">

    <header class="bg-white border-b border-gray-200 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
            <div class="flex items-center gap-2">
                <span class="material-symbols-outlined text-blue-600 text-3xl">cloud_circle</span>
                <h1 class="font-bold text-xl tracking-tight">FileVault</h1>
            </div>
            <div class="w-8 h-8 bg-purple-100 rounded-full flex items-center justify-center text-purple-600 font-bold text-xs">
                U
            </div>
        </div>
    </header>

    <div class="bg-white border-b border-gray-200 px-4 py-3 sticky top-[57px] z-40">
        <div class="max-w-7xl mx-auto relative">
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                <span class="material-symbols-outlined text-gray-400">search</span>
            </div>
            <input 
                id="searchInput"
                oninput="filterFiles(this.value)" 
                class="block w-full pl-10 pr-4 py-3 bg-gray-100 border-none rounded-xl text-gray-900 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:bg-white transition-all" 
                placeholder="Search in Drive" 
                type="text"
            />
        </div>
    </div>

    <main class="max-w-7xl mx-auto px-4 py-6 pb-32">
        
        <div id="suggestedSection" class="mb-8 hidden">
            <h3 class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-3">Suggested</h3>
            <div id="suggestedGrid" class="grid grid-cols-2 gap-3">
                </div>
        </div>

        <div id="folderSection" class="mb-8">
            <h3 class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-3">Folders</h3>
            <div id="folderGrid" class="grid grid-cols-2 sm:grid-cols-3 gap-3">
                <div class="col-span-full text-gray-400 text-sm italic">Loading folders...</div>
            </div>
        </div>

        <div id="fileListSection">
            <div class="flex justify-between items-end mb-3 border-b border-gray-200 pb-2">
                <h3 class="text-xs font-bold text-gray-500 uppercase tracking-wider">Files</h3>
                <span id="fileCount" class="text-[10px] text-gray-400 font-bold"></span>
            </div>
            <div id="fileGrid" class="flex flex-col gap-2">
                </div>
        </div>

    </main>

    <div class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 p-4 z-50">
        <div class="max-w-7xl mx-auto text-center">
            <a href="login.html" class="inline-flex items-center gap-2 text-xs font-bold text-gray-400 hover:text-blue-600 transition-colors">
                <span class="material-symbols-outlined text-sm">lock</span>
                Manager Portal Access
            </a>
        </div>
    </div>

<script>
    // 1. INITIALIZE SUPABASE
    const _supabase = supabase.createClient('https://lvhecpvwpzmstciewziv.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx2aGVjcHZ3cHptc3RjaWV3eml2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAwODIzODIsImV4cCI6MjA4NTY1ODM4Mn0.kjaJKidkubl-_-K87WEAe91puG1qoEvJqnfcOiaG2kI');

    let allFiles = []; // Master list

    // --- HELPER: ICONS ---
    function getFileIcon(fileName) {
        const name = fileName.toLowerCase();
        if (name.endsWith('.pdf')) return 'picture_as_pdf';
        if (name.endsWith('.pptx') || name.endsWith('.ppt')) return 'slideshow';
        if (name.endsWith('.docx') || name.endsWith('.doc')) return 'description';
        if (name.endsWith('.xlsx') || name.endsWith('.csv')) return 'table_chart';
        if (name.endsWith('.zip') || name.endsWith('.rar')) return 'folder_zip';
        if (name.endsWith('.jpg') || name.endsWith('.png') || name.endsWith('.jpeg')) return 'image';
        return 'description'; 
    }

    // --- HELPER: COLORS ---
    function getFileColor(fileName) {
        const name = fileName.toLowerCase();
        if (name.endsWith('.pdf')) return 'text-red-500 bg-red-50';
        if (name.endsWith('.docx') || name.endsWith('.doc')) return 'text-blue-600 bg-blue-50';
        if (name.endsWith('.pptx') || name.endsWith('.ppt')) return 'text-orange-500 bg-orange-50';
        if (name.endsWith('.xlsx') || name.endsWith('.csv')) return 'text-green-600 bg-green-50';
        if (name.endsWith('.jpg') || name.endsWith('.png')) return 'text-purple-600 bg-purple-50';
        return 'text-slate-500 bg-slate-100';
    }

    // --- MAIN FETCH FUNCTION ---
    async function fetchFiles() {
    const fileGrid = document.getElementById('fileGrid');
    
    try {
        // 1. Get List (Recursive)
        const { data, error } = await _supabase.storage
            .from('vault-files')
            .list('', { limit: 100, sortBy: { column: 'created_at', order: 'desc' }, recursive: true });

        if (error) throw error;

        // 2. SIMPLIFIED FILTER: Just hide the system placeholders
        // We removed the "id !== null" check because it might be hiding real files on your version
        const realFiles = data.filter(f => 
            f.name !== 'uploads' && 
            !f.name.endsWith('.emptyFolderPlaceholder')
        );

        allFiles = realFiles.map(file => {
            const { data: urlData } = _supabase.storage.from('vault-files').getPublicUrl(file.name);
            const displayName = file.name.split('/').pop();
            const folderName = file.name.includes('/') ? file.name.split('/')[0] : 'Unsorted';
            
            return {
                name: displayName,
                folder: folderName,
                fullPath: file.name,
                url: urlData.publicUrl,
                date: new Date(file.created_at)
            };
        });

        if (allFiles.length === 0) {
            fileGrid.innerHTML = `<div class="text-center py-10 text-gray-400">No files found.</div>`;
            return;
        }

        renderAll(allFiles);

    } catch (err) {
        console.error(err);
        fileGrid.innerHTML = `<div class="text-center py-10 text-red-400">Error loading library.</div>`;
    }
}

    // --- RENDER FUNCTION (Draws the whole UI) ---
    function renderAll(files) {
    // 1. SUGGESTED SECTION (Top 2 Newest)
    const suggested = files.slice(0, 2); 
    const suggestedGrid = document.getElementById('suggestedGrid');
    
    if (suggested.length > 0) {
        document.getElementById('suggestedSection').classList.remove('hidden');
        suggestedGrid.innerHTML = suggested.map(file => {
            const icon = getFileIcon(file.name);
            const colorClasses = getFileColor(file.name);
            const [textColor, bgColor] = colorClasses.split(' ');
            
            return `
                <div class="bg-white p-4 rounded-2xl border border-gray-100 shadow-sm flex flex-col justify-between h-32 relative overflow-hidden group">
                    <div class="${bgColor} w-10 h-10 rounded-lg flex items-center justify-center mb-2">
                        <span class="material-symbols-outlined ${textColor}">${icon}</span>
                    </div>
                    <div class="z-10">
                        <p class="font-bold text-gray-800 text-sm truncate mb-1" title="${file.name}">${file.name}</p>
                        <a href="${file.url}" target="_blank" class="text-[10px] font-bold text-blue-600 uppercase hover:underline">Open File</a>
                    </div>
                </div>
            `;
        }).join('');
    }

    // 2. FOLDERS SECTION (Clicking these filters the list below)
    const folders = [...new Set(files.map(f => f.folder))].sort();
    const folderGrid = document.getElementById('folderGrid');
    
    // "All Files" Button
    let folderHtml = `
        <div onclick="filterByFolder('ALL')" class="bg-blue-50 p-4 rounded-2xl border border-blue-100 shadow-sm flex items-center gap-3 cursor-pointer active:scale-95 transition-transform select-none">
            <span class="material-symbols-outlined text-blue-600">grid_view</span>
            <span class="font-bold text-blue-700 text-sm">All Files</span>
        </div>
    `;

    // Dynamic Folders
    folderHtml += folders.map(folder => `
        <div onclick="filterByFolder('${folder}')" class="bg-white p-4 rounded-2xl border border-gray-200 shadow-sm flex items-center gap-3 cursor-pointer hover:bg-gray-50 active:scale-95 transition-transform select-none">
            <span class="material-symbols-outlined text-gray-500">folder</span>
            <span class="font-semibold text-gray-700 text-sm truncate">${folder}</span>
        </div>
    `).join('');
    
    folderGrid.innerHTML = folderHtml;

    // 3. RENDER THE FILE LIST INITIALLY
    renderFileList(files);
}

    // --- RENDER JUST THE FILE LIST (Used by filters) ---
    function renderFileList(filesToRender) {
        const fileGrid = document.getElementById('fileGrid');
        document.getElementById('fileCount').innerText = `${filesToRender.length} items`;

        if (filesToRender.length === 0) {
            fileGrid.innerHTML = `<p class="text-center text-gray-400 py-8 text-sm">No files found.</p>`;
            return;
        }

        fileGrid.innerHTML = filesToRender.map(file => {
            const icon = getFileIcon(file.name);
            return `
                <div class="bg-white p-3 rounded-xl border border-gray-100 flex items-center justify-between shadow-sm active:bg-gray-50 transition-colors">
                    <div class="flex items-center gap-3 overflow-hidden">
                        <span class="material-symbols-outlined text-gray-400 text-2xl">${icon}</span>
                        <div class="min-w-0">
                            <p class="text-sm font-semibold text-gray-700 truncate">${file.name}</p>
                            <p class="text-[10px] text-gray-400 flex items-center gap-1">
                                ${file.folder}
                            </p>
                        </div>
                    </div>
                    <a href="${file.url}" target="_blank" class="text-gray-400 hover:text-blue-600 p-2">
                        <span class="material-symbols-outlined">download</span>
                    </a>
                </div>
            `;
        }).join('');
    }

    // --- FILTERS ---
    function filterByFolder(folderName) {
        if (folderName === 'ALL') {
            renderFileList(allFiles);
        } else {
            const filtered = allFiles.filter(f => f.folder === folderName);
            renderFileList(filtered);
        }
    }

    function filterFiles(searchTerm) {
        const term = searchTerm.toLowerCase();
        const filtered = allFiles.filter(f => f.name.toLowerCase().includes(term));
        renderFileList(filtered);
    }

    // Start App
    fetchFiles();

</script>
</body>
</html>
